# CI/CD Integration Server å°ˆæ¡ˆç¸½çµ

## å°ˆæ¡ˆå®Œæˆç‹€æ…‹

### âœ… å·²å®Œæˆ

#### é…ç½®æ–‡ä»¶å‰µå»º
- [x] å››å€‹ Kind Cluster é…ç½®ï¼ˆArgoCDã€Gitã€Appã€Backstageï¼‰
- [x] Gitea Docker Compose é…ç½®
- [x] Gitea Runner Docker Compose é…ç½®
- [x] Docker Registry Kubernetes manifests
- [x] ArgoCD Application ç¯„ä¾‹
- [x] CI/CD Workflow ç¯„ä¾‹
- [x] è³‡æ–™åº« Migration è…³æœ¬ï¼ˆFlywayï¼‰

#### è‡ªå‹•åŒ–è…³æœ¬
- [x] Docker æ¬Šé™è¨­ç½®è…³æœ¬
- [x] Cluster å‰µå»ºè…³æœ¬ï¼ˆä¸€èˆ¬ & sudo ç‰ˆæœ¬ï¼‰
- [x] ä¸€éµéƒ¨ç½²è…³æœ¬ (deploy-all.sh)
- [x] è³‡æ–™åº«é€£ç·šæ¸¬è©¦è…³æœ¬

#### æ–‡ä»¶æ’°å¯«
- [x] ä¸»è¦ READMEï¼ˆå®Œæ•´æŒ‡å—ï¼‰
- [x] Gitea Runner è¨­å®šæŒ‡å—
- [x] ArgoCD ä½¿ç”¨æŒ‡å—
- [x] è©³ç´°ä»»å‹™æ¸…å–® (tasks-gitea.md)

### ğŸ“‹ å¾…åŸ·è¡Œï¼ˆéœ€è¦ä½¿ç”¨è€…æ“ä½œï¼‰

1. **åŸ·è¡Œéƒ¨ç½²è…³æœ¬**
   ```bash
   ./deploy-all.sh
   ```
   æˆ–æ‰‹å‹•åŸ·è¡Œ `create-clusters-sudo.sh`

2. **å®Œæˆ Gitea åˆå§‹è¨­å®š**
   - è¨ªå• http://gitea.local:3001
   - å»ºç«‹ç®¡ç†å“¡å¸³è™Ÿ
   - å»ºç«‹ Organization å’Œ Repositories

3. **é…ç½® Gitea Actions Runner**
   - å–å¾— Registration Token
   - é…ç½® `.env` æª”æ¡ˆ
   - å•Ÿå‹• Runner

4. **é…ç½® ArgoCD**
   - é€£æ¥ Gitea repository
   - å»ºç«‹ Access Token
   - éƒ¨ç½² Application

5. **æ¸¬è©¦å®Œæ•´ CI/CD æµç¨‹**
   - Push ç¨‹å¼ç¢¼è§¸ç™¼ CI
   - é©—è­‰è‡ªå‹•éƒ¨ç½²

## å°ˆæ¡ˆæ¶æ§‹

### å››å±¤æ¶æ§‹è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ArgoCD Cluster (kind-argocd-cluster)  â”‚
â”‚    - ArgoCD (GitOps CD)                  â”‚
â”‚    - Port: 8443 (éœ€ port-forward)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Git Cluster (kind-git-cluster)        â”‚
â”‚    - ä¿ç•™ä¾›æœªä¾†æ“´å±•                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    App Cluster (kind-app-cluster)        â”‚
â”‚    - Docker Registry (Port: 5000)        â”‚
â”‚    - Registry UI (Port: 8081)            â”‚
â”‚    - Applications (ç”± ArgoCD éƒ¨ç½²)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backstage Cluster (kind-backstage)      â”‚
â”‚    - Backstage Developer Portal          â”‚
â”‚    - PostgreSQL                          â”‚
â”‚    - Port: 7007 (HTTP)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Gitea (Docker Container)              â”‚
â”‚    - Port: 3001 (HTTP), 2223 (SSH)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CI/CD æµç¨‹

```
é–‹ç™¼è€… Push Code
    â†“
Gitea Actions è§¸ç™¼ CI
    â†“
Build â†’ Test â†’ Build Image â†’ Push to Registry
    â†“
æ›´æ–° GitOps Repository (image tag)
    â†“
ArgoCD åµæ¸¬è®Šæ›´
    â†“
è‡ªå‹•åŒæ­¥åˆ° K8s Cluster
    â†“
æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²å®Œæˆ
```

## æª”æ¡ˆçµ±è¨ˆ

### Git æäº¤æ­·å²

```bash
git log --oneline --all --graph
```

é æœŸæœ‰ä»¥ä¸‹æäº¤ï¼š
1. å»ºç«‹ä¸‰å€‹ Kind cluster é…ç½®æª”
2. Docker è¨­ç½®èˆ‡ Cluster å‰µå»ºè…³æœ¬
3. ä½¿ç”¨ sudo çš„ Cluster å‰µå»ºè…³æœ¬
4. Giteaã€Registryã€ArgoCD éƒ¨ç½²é…ç½®èˆ‡è‡ªå‹•åŒ–è…³æœ¬
5. Workflow ç¯„ä¾‹ã€è³‡æ–™åº«è…³æœ¬èˆ‡ ArgoCD é…ç½®æ–‡ä»¶
6. README å®Œæ•´ä½¿ç”¨èˆ‡ç¶­è­·æŒ‡å—

### ç›®éŒ„çµæ§‹

```
cicd/ (å°ˆæ¡ˆæ ¹ç›®éŒ„)
â”œâ”€â”€ é…ç½®æ–‡ä»¶ (7 å€‹ YAML)
â”œâ”€â”€ è…³æœ¬æª”æ¡ˆ (4 å€‹ .sh)
â”œâ”€â”€ æ–‡ä»¶æª”æ¡ˆ (5 å€‹ .md)
â”œâ”€â”€ gitea/ (1 å€‹æª”æ¡ˆ)
â”œâ”€â”€ gitea-runner/ (3 å€‹æª”æ¡ˆ)
â”œâ”€â”€ registry/ (3 å€‹æª”æ¡ˆ)
â”œâ”€â”€ argocd/ (2 å€‹æª”æ¡ˆ)
â”œâ”€â”€ workflows/ (2 å€‹æª”æ¡ˆ)
â””â”€â”€ db/ (4 å€‹æª”æ¡ˆ)
```

## æŠ€è¡“æ£§

### æ ¸å¿ƒå…ƒä»¶
- **Kind**: v0.20+ (Kubernetes in Docker)
- **Gitea**: 1.21+ (è¼•é‡ Git æœå‹™)
- **Gitea act_runner**: 0.2.6+ (CI Runner)
- **ArgoCD**: 2.9+ (GitOps CD)
- **Docker Registry**: 2.x
- **Oracle XE**: 21.3.0 (æ¸¬è©¦ç”¨)

### è¼”åŠ©å·¥å…·
- **Docker / Docker Compose**
- **kubectl**
- **Helm** (å¯é¸)

## è³‡æºéœ€æ±‚

### è¨˜æ†¶é«”é…ç½®ï¼ˆé ä¼°ï¼‰

| çµ„ä»¶ | é…ç½® |
|------|------|
| Host OS | 4 GB |
| Docker Engine | 2 GB |
| Gitea | 0.5 GB |
| Gitea Runner | 0.5 GB |
| Kind Clusters | 16 GB |
| ç·©è¡ç©ºé–“ | 20+ GB |
| **ç¸½è¨ˆ** | **~45 GB** |

### ç£ç¢Ÿç©ºé–“
- Docker images & volumes: ~150 GB
- Kind clusters: ~10 GB
- **å»ºè­°ç¸½ç©ºé–“**: 512 GB SSD

## ä¸‹ä¸€æ­¥å»ºè­°

### ç«‹å³åŸ·è¡Œ
1. åŸ·è¡Œ `./deploy-all.sh` æˆ–æ‰‹å‹•å‰µå»º clusters
2. å®Œæˆ Gitea åˆå§‹è¨­å®š
3. é…ç½® Runner ä¸¦æ¸¬è©¦ workflow

### é€²éšé…ç½®ï¼ˆå¯é¸ï¼‰
1. é…ç½® Ingress Controller æ”¯æ´é ç«¯è¨ªå•
2. é…ç½® Metrics Server å’Œ Monitoring
3. è¨­å®š HTTPS å’Œèªè­‰
4. é…ç½®å‚™ä»½è‡ªå‹•åŒ–

### ç”Ÿç”¢ç’°å¢ƒå»ºè­°
1. ä½¿ç”¨çœŸå¯¦ Kubernetes clusterï¼ˆé Kindï¼‰
2. é…ç½®æŒä¹…åŒ–å­˜å„²ï¼ˆNFS / Cephï¼‰
3. è¨­å®šé«˜å¯ç”¨æ€§ï¼ˆHAï¼‰
4. å¯¦æ–½å®‰å…¨åŠ å›ºï¼ˆRBACã€Network Policyï¼‰
5. é…ç½®æ—¥èªŒæ”¶é›†ï¼ˆELK Stackï¼‰

## å­¸ç¿’è³‡æº

- ğŸ”— [Gitea Documentation](https://docs.gitea.io/)
- ğŸ”— [Gitea Actions](https://docs.gitea.io/en-us/actions-overview/)
- ğŸ”— [ArgoCD Documentation](https://argo-cd.readthedocs.io/)
- ğŸ”— [Kind Documentation](https://kind.sigs.k8s.io/)
- ğŸ”— [GitOps Principles](https://opengitops.dev/)

## å°ˆæ¡ˆç¶­è­·

### å®šæœŸæª¢æŸ¥
- æ¯é€±æª¢æŸ¥å®¹å™¨ç‹€æ…‹ï¼š`docker ps -a`
- æ¯é€±æª¢æŸ¥ç£ç¢Ÿç©ºé–“ï¼š`df -h`
- æ¯æœˆæ¸…ç†æœªä½¿ç”¨çš„ imagesï¼š`docker system prune`

### ç‰ˆæœ¬æ›´æ–°
- å®šæœŸæ›´æ–° Gitea: ä¿®æ”¹ `docker-compose.yaml` ä¸­çš„ image tag
- å®šæœŸæ›´æ–° ArgoCD: é‡æ–° apply manifest
- å®šæœŸæ›´æ–° Kind: ä¸‹è¼‰æ–°ç‰ˆ CLI

### å‚™ä»½ç­–ç•¥
- **æ¯æ—¥**: Gitea è³‡æ–™å‚™ä»½ï¼ˆä½¿ç”¨ `gitea dump`ï¼‰
- **æ¯é€±**: Registry è³‡æ–™å‚™ä»½
- **æ¯æœˆ**: å®Œæ•´é…ç½®æª”æ¡ˆå‚™ä»½

---

**å°ˆæ¡ˆå»ºç«‹æ—¥æœŸ**: 2025-12-14
**æœ€å¾Œæ›´æ–°**: 2025-12-14
**ç‰ˆæœ¬**: v1.0
**ç‹€æ…‹**: é…ç½®å®Œæˆï¼Œå¾…éƒ¨ç½²åŸ·è¡Œ
